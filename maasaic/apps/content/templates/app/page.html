{% extends 'app/_base.html' %}

{% load static %}
{% load times %}
{% load content %}
{% load bootstrap4 %}

{% block title %}{% if page_edit_on %}EDIT: {% endif %}{{ page.title }}{% endblock %}

{% block body_class %}{% if page_edit_on %}body-edit-page{% endif %}{% endblock %}

{% block extra_js %}
  {% include 'widgets/fonts.html' %}
  {% if page_edit_on %}
  <script type="text/javascript">
    var csrfmiddlewaretoken = '{{ csrf_token }}';
    var subdomain = '{{ website.subdomain }}';
  </script>
  {% endif %}
{% endblock %}

{% block content %}
{% if page_edit_on %}
  {# BEING: AJAX CONTAINER #}
  <div id="js-ajax-container">
{% endif %}
<div class="page"
     data-website-id="{{ page.website.id }}"
     data-website-pub_status="{{ page.website.pub_status }}"
     data-website-subdomain="{{ page.website.subdomain }}"
     data-website-name="{{ page.website.name }}"
     data-website-description="{{ page.website.description }}"
     data-website-language="{{ page.website.language }}"
     data-website-page_width="{{ page.website.page_width }}"
     data-page-id="{{ page.pk }}"
     data-pub_status="{{ page.pub_status }}"
     data-name="{{ page.name }}"
     data-path="{{ page.path }}"
     data-page_width="{{ page.page_width }}"
     data-description="{{ page.description }}">
  {% for section in page.visible_sections %}
    <div class="section
                section--{{ section.n_columns }}-columns
                section--{{ section.n_rows }}-rows
                section--{{ section.cell_height }}-height"
         style="{% for key, val in section.css.items %}{{ key }}:{{ val }};{% endfor %}"
         data-pub_status="{{ section.pub_status }}"
         data-order="{{ section.order }}"
         data-n_columns="{{ section.n_columns }}"
         data-cell_height="{{ section.cell_height }}"
         data-cell_default_padding="{% section_cell_default_padding section %}"
         data-cell_default_margin="{% section_cell_default_margin section %}"
         data-cell_default_background="{% section_cell_default_background section %}"
         data-cell_default_shadow="{% section_cell_default_shadow section %}"
         data-cell_default_border="{% section_cell_default_border section %}"
         data-cell_default_border_radius="{% section_cell_default_border_radius section %}"
         data-width="{% page_width page %}"
         data-name="{{ section.name }}"
         data-slug="{{ section.slug }}"
         data-section-id="{{ section.pk }}">
      <div class="section-inner"
           style="width: {% page_width page %}px">

        {# VIEW LAYER #}
        <div class="view-layer">
          {% for cell in section.visible_cells|slice:"::-1" %}
            <div class="cell
                        cell--layer-view
                        {% if page_edit_on %}no-select{% endif%}
                        cell--w-{{ cell.w }}
                        cell--h-{{ cell.h }}
                        cell--x-{{ cell.x }}
                        cell--y-{{ cell.y }}"
                 data-cell-id="{{ cell.pk }}"
                 data-section-id="{{ section.pk }}"
                 data-type="{{ cell.cell_type }}"
                 data-w="{{ cell.w }}"
                 data-h="{{ cell.h }}"
                 data-x="{{ cell.x }}"
                 data-y="{{ cell.y }}">
              <div class="cell-inner-margin" style="{% cell_inner_style_background cell %} {% cell_inner_style_margin_position cell %} border:{{ cell.css.border }}; border-radius: {{ cell.css.border_radius }}; box-shadow: {{ cell.css.box_shadow }}">
                <div class="cell-inner-padding" style="{% cell_inner_style_padding cell %}">
                  <div class="cell-inner">
                    {{ cell.content|safe }}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        {% if page_edit_on %}
          {# INSERT LAYER #}
          <div class="insert-layer"
               data-section-id="{{ section.id }}">
            {% for row in section.n_rows|times %}
              {% for col in section.n_columns|times %}
                <div class="cell
                            cell--layer-insert
                            cell--w-1
                            cell--h-1
                            cell--x-{{ col }}
                            cell--y-{{ row }}"
                     data-section-id="{{ section.pk }}"
                     data-x="{{ col }}"
                     data-y="{{ row }}">
                </div>
              {% endfor %}
            {% endfor %}
            <div class="insert-cell-ctrl hidden"
                 data-section-id="{{ section.pk }}">
              <div class="insert-cell-btn
                          js-insert-cell-btn"
                   data-cell-type="TEXT">
                <div class="icon">
                  <i class="fa fa-font"></i>
                </div>
                <div class="text">Text</div>
              </div>
              <div class="insert-cell-btn
                          js-insert-cell-btn"
                   data-cell-type="IMAGE">
                <div class="icon">
                  <i class="fa fa-camera"></i>
                </div>
                <div class="text">Image</div>
              </div>
              <div class="insert-cell-btn no-margin-right
                          js-insert-cell-btn"
                   data-cell-type="VIDEO">
                <div class="icon">
                  <i class="fa fa-youtube"></i>
                </div>
                <div class="text">Video</div>
              </div>
              <div class="insert-cell-btn
                          js-insert-cell-btn"
                   data-cell-type="CLONE">
                <div class="icon">
                  <i class="fa fa-clone"></i>
                </div>
                <div class="text">Clone</div>
              </div>
              <div class="insert-cell-btn
                          js-insert-cell-btn"
                   data-cell-type="IFRAME">
                <div class="icon">
                  <i class="fa fa-code"></i>
                </div>
                <div class="text">Iframe</div>
              </div>
            </div>
          </div>

          {# EDIT LAYER #}
          <div class="edit-layer">
            {% for cell in section.editable_cells|slice:"::-1" %}
              <div class="cell
                          cell--layer-edit
                          cell--w-{{ cell.w }}
                          cell--h-{{ cell.h }}
                          cell--x-{{ cell.x }}
                          cell--y-{{ cell.y }}"
                   data-cell-id="{{ cell.pk }}"
                   data-section-id="{{ section.pk }}"
                   data-type="{{ cell.cell_type }}"
                   data-margin="{{ cell.css.margin }}"
                   data-padding="{{ cell.css.padding }}"
                   data-position="{% cell_inner_style_margin_position cell %}"
                   data-background="{{ cell.css.background }}"
                   data-border="{{ cell.css.border }}"
                   data-border_radius="{{ cell.css.border_radius }}"
                   data-shadow="{{ cell.css.box_shadow }}"
                   data-w="{{ cell.w }}"
                   data-h="{{ cell.h }}"
                   data-x="{{ cell.x }}"
                   data-y="{{ cell.y }}">
                <div class="edit-cell-ctrl">
                  <div class="edit-cell-ctrl-btns">
                    <div class="edit-cell-ctrl-btn
                                js-edit-cell-ctrl-btn-move">
                      <div class="icon">
                        <i class="fa fa-arrows"></i>
                      </div>
                      <span class="text">Move</span>
                    </div>
                    <div class="edit-cell-ctrl-btn
                                js-edit-cell-ctrl-btn-edit">
                      <div class="icon">
                        <i class="fa fa-edit"></i>
                      </div>
                      <span class="text">Edit</span>
                    </div>
                    <div class="edit-cell-ctrl-btn
                                js-edit-cell-ctrl-btn-delete">
                      <div class="icon">
                        <i class="fa fa-times"></i>
                      </div>
                      <span class="text">Delete</span>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          {# MOVE LAYER #}
          <div class="move-layer hidden">
            {% for row in section.n_rows|times %}
              {% for col in section.n_columns|times %}
                <div class="cell
                            cell--layer-move
                            cell--w-1
                            cell--h-1
                            cell--x-{{ col }}
                            cell--y-{{ row }}"
                     data-section-id="{{ section.pk }}"
                     data-x="{{ col }}"
                     data-y="{{ row }}">
                </div>
              {% endfor %}
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

{# Sidebar #}
{% if page_edit_on %}
  <div id="sidebar">
    <div id="sidebar-inner">
      {# Website #}
      <h3 class="sidebar-title">
        Website <span class="sidebar-title-status">{% if website.is_visible %}<i class="fa fa-circle text-success"></i> Live{% else %}<i class="fa fa-circle text-danger"></i> Offline{% endif %}</span>
      </h3>
      <div class="sidebar-item">
        <div class="sidebar-item-option left">
          <div class="sidebar-dropdown-wrapper"
               id="js-website-select-dropdown">
            <div class="sidebar-option-btn bordered">
              <i class="fa fa-angle-down"></i>
            </div>
            <ul class="sidebar-dropdown">
              {% for web in user.website_set.all %}
                <li><a href="#">
                  <span class="name">{{ web.name }}</span>
                  <span class="description">{{ web.domain }}</span>
                </a></li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="sidebar-item-option right">
          <a class="sidebar-option-btn" href="{% url 'website_detail' website.subdomain %}">
            <i class="fa fa-edit"></i>
          </a>
        </div>
        <div class="sidebar-item-content">
          <h2 class="name">{{ website.name }}</h2>
          <h3 class="description">{{ website.domain|truncatechars:26 }}</h3>
        </div>
      </div>

      {# Page #}
      <h3 class="sidebar-title">
        <form method="POST" action="{% url 'page_publish' website.subdomain page.target_page.pk %}?next={{ request.path }}">
          {% csrf_token %}
          <input type="hidden" name="is_visible" value="True" />
          <button type="submit" class="title-btn">
            Publish <i class="fa fa-check"></i>
          </button>
        </form>
        <form method="POST" action="{% url 'page_reset' website.subdomain page.pk %}?next={{ request.path }}">
          {% csrf_token %}
          <button type="submit" class="title-btn" style="margin-right: 5px">
            Reset <i class="fa fa-refresh"></i>
          </button>
        </form>
        Page <span class="sidebar-title-status">{% if page.target_page.is_visible %}<i class="fa fa-circle text-success"></i> Live{% else %}<i class="fa fa-circle text-danger"></i> Offline{% endif %}</span>
      </h3>
      <div class="sidebar-item">
        <div class="sidebar-item-option left">
          <div class="sidebar-dropdown-wrapper"
               id="js-page-select-dropdown">
            <div class="sidebar-option-btn bordered">
              <i class="fa fa-angle-down"></i>
            </div>
            <ul class="sidebar-dropdown">
              {% for page in website.edit_pages %}
                <li><a href="{% url 'page_update' website.subdomain page.pk %}">
                  <span class="name">{{ page.title }}</span>
                  <span class="description">{{ page.path }}</span>
                </a></li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="sidebar-item-option right">
          <a class="sidebar-option-btn" href="{% url 'page_config' website.subdomain page.target_page.pk %}">
            <i class="fa fa-edit"></i>
          </a>
        </div>
        <div class="sidebar-item-content">
          <h2 class="name" title="{{ page.title }}">{{ page.title|truncatechars:25 }}</h2>
          <h3 class="description" title="{{ page.path }}">{{ page.path|truncatechars:20 }}</h3>
        </div>
      </div>
      {# Sections #}
      <h3 class="sidebar-title">
        Sections
        <button type="button" class="title-btn js-section-add-btn" data-toggle="modal" data-target="#create-section-modal">
          Add <i class="fa fa-plus"></i>
        </button>
      </h3>
      <ul class="section-list" id="js-section-list">
        {% for section in page.all_sections %}
          <li class="section-list-item" data-section-id="{{ section.pk }}">
            <div class="sidebar-item">
              <div class="sidebar-item-option left">
                <div class="sidebar-option-btn bordered grab drag-handle">
                  <i class="fa fa-reorder"></i>
                </div>
              </div>
              <div class="sidebar-item-option right">
                <div class="sidebar-option-btn">
                  <i class="fa fa-edit"></i>
                </div>
              </div>
              <div class="sidebar-item-option right">
                <form method="post" action="{% url 'section_update_visibility' section.pk %}" class="js-ajax-form">
                  {% csrf_token %}
                  <input type="hidden" name="is_visible" value="{% if section.is_visible %}False{% else %}True{% endif %}" />
                  <button class="sidebar-option-btn" type="submit">
                    {% if section.is_visible %}<i class="fa fa-eye"></i>
                    {% else %}<i class="fa fa-eye-slash"></i>{% endif %}
                  </button>
                </form>
              </div>
              <div class="sidebar-item-content">
                <h2 class="name">{{ section.name }}</h2>
                <h3 class="description">(C:{{ section.n_columns }}, R:{{ section.n_rows }}, H:{{ section.cell_height }}px)</h3>
              </div>
            </div>

            {# Cells #}
            <ul class="cell-list" data-section-id="{{ section.pk }}">
              {% for cell in section.all_cells %}
                <li class="cell-list-item"
                    data-section-id="{{ section.pk }}"
                    data-cell-id="{{ cell.pk }}">
                  <div class="sidebar-item {% if not cell.is_visible %}not-visible{% endif %}">
                    <div class="sidebar-item-option left">
                      <div class="sidebar-option-btn bordered grab drag-handle">
                        <i class="fa fa-reorder"></i>
                      </div>
                    </div>
                    <div class="sidebar-item-option right">
                      <div class="sidebar-option-btn">
                        <i class="fa fa-edit"></i>
                      </div>
                    </div>
                    <div class="sidebar-item-option right">
                      <form method="post" action="{% url 'cell_update_visibility' cell.pk %}" class="js-ajax-form">
                        {% csrf_token %}
                        <input type="hidden" name="is_visible" value="{% if cell.is_visible %}False{% else %}True{% endif %}" />
                        <button class="sidebar-option-btn" type="submit">
                          {% if cell.is_visible %}<i class="fa fa-eye"></i>
                          {% else %}<i class="fa fa-eye-slash"></i>{% endif %}
                        </button>
                      </form>
                    </div>
                    <div class="sidebar-item-content">
                      <h2 class="name">{% cell_type_icon cell %} | {% cell_short_text cell %}</h2>
                      <h3 class="description"><span class="coordinate">x:</span> {{ cell.x }}, <span class="coordinate">y:</span> {{ cell.y }}, <span class="coordinate">w:</span> {{ cell.w }}, <span class="coordinate">h:</span> {{ cell.h }}</h3>
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endif %}

{# js-ajax-container #}
{% if page_edit_on %}
  </div>
{% endif %}

{# Popups #}
{% if page_edit_on %}
  <div class="modal" tabindex="-1" role="dialog" id="create-section-modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"> Create section</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="POST" action="{% url 'section_create' %}" class="form-horizontal">
          <div class="modal-body">
              {% csrf_token %}
              {% bootstrap_form section_create_form %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-link text-danger" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success"><i class="fa fa-plus-circle"></i> Create section</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {# INSERT CELL MODAL #}
  <div class="modal" tabindex="-1" role="dialog" id="insert-cell-modal">
    <div class="modal-dialog modal-huge" role="document">
      <div class="modal-content"></div>
    </div>
  </div>

  {# CELL PROPERTIES #}
  <div id="cell-properties-template" class="hidden">
    <h5>Cell properties</h5>
    <div class="row">
      <div class="col">
        <label>Background</label>
        <div class="input-group colorpicker-component colorpicker-element">
          <div class="input-group-prepend">
            <span class="input-group-text input-group-addon"><i></i></span>
          </div>
          <input type="text" name="css_background" class="form-control input-sm"/>
        </div>
      </div>
      <div class="col">
        <label>Margin</label>
        <input type="text" name="css_margin" class="form-control input-sm"/>
      </div>
      <div class="col">
        <label>Padding</label>
        <input type="text" name="css_padding" class="form-control input-sm"/>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <br/>
        <label>Border</label>
        <input type="text" name="css_border" class="form-control input-sm"/>
      </div>
      <div class="col">
        <br/>
        <label>Border radius</label>
        <input type="text" name="css_border_radius" class="form-control input-sm"/>
      </div>
      <div class="col">
        <br/>
        <label>Shadow</label>
        <input type="text" name="css_shadow" class="form-control input-sm"/>
      </div>
    </div>
  </div>
{% endif %}

{# loading #}
<div id="loading-overlay" class="hidden">
  <div id="loading-msg">
    <i class="fa fa-circle-o-notch fa-spin"></i> waiting for response
  </div>
</div>
{% endblock %}
